{
  "Comment": "Greencoop Data Pipeline - Python-only tasks",
  "StartAt": "RunPreprocessing",
  "States": {
    "RunPreprocessing": {
      "Type": "Task",
      "Resource": "arn:aws:states:::ecs:runTask.sync",
      "Parameters": {
        "LaunchType": "FARGATE",
        "Cluster": "greencoop-cluster",
        "TaskDefinition": "greencoop-preprocessing",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "Subnets": ["$SUBNET_ID"],
            "SecurityGroups": ["$SECURITY_GROUP_ID"],
            "AssignPublicIp": "ENABLED"
          }
        }
      },
      "Next": "RunIngestion",
      "Catch": [
        { "ErrorEquals": ["States.ALL"], "Next": "PipelineFailed" }
      ]
    },

    "RunIngestion": {
      "Type": "Task",
      "Resource": "arn:aws:states:::ecs:runTask.sync",
      "Parameters": {
        "LaunchType": "FARGATE",
        "Cluster": "greencoop-cluster",
        "TaskDefinition": "greencoop-ingestion",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "Subnets": ["$SUBNET_ID"],
            "SecurityGroups": ["$SECURITY_GROUP_ID"],
            "AssignPublicIp": "ENABLED"
          }
        }
      },
      "Next": "RunQualityChecker",
      "Catch": [
        { "ErrorEquals": ["States.ALL"], "Next": "PipelineFailed" }
      ]
    },

    "RunQualityChecker": {
      "Type": "Task",
      "Resource": "arn:aws:states:::ecs:runTask.sync",
      "Parameters": {
        "LaunchType": "FARGATE",
        "Cluster": "greencoop-cluster",
        "TaskDefinition": "greencoop-quality-checker",
        "NetworkConfiguration": {
          "AwsvpcConfiguration": {
            "Subnets": ["$SUBNET_ID"],
            "SecurityGroups": ["$SECURITY_GROUP_ID"],
            "AssignPublicIp": "ENABLED"
          }
        }
      },
      "Next": "PipelineSucceeded",
      "Catch": [
        { "ErrorEquals": ["States.ALL"], "Next": "PipelineFailed" }
      ]
    },

    "PipelineSucceeded": { "Type": "Succeed" },
    "PipelineFailed": {
      "Type": "Fail",
      "Error": "PipelineExecutionFailed",
      "Cause": "A step in the data pipeline failed"
    }
  }
}
